{"workflow":[{"name":"parameters","type":"parameter","nodeType":"parameter","description":"","properties":{"qa":{"spark-runtime":"Kenisis-Environment"},"default":{},"prod":{"spark-runtime":"Kenisis-Environment"},"dev":{"spark-runtime":"Databricks-Cluster-Dev"},"staging":{"spark-runtime":"Kenisis-Environment"},"demo":{"spark-runtime":"Kenisis-Environment"},"example":{"spark-runtime":"Kenisis-Environment"}}},{"name":"wpv_circumstances_class_lkup","type":"table","nodeType":"source","description":"","properties":{"select":"wpv_class_of_circumstances","designSchema":81,"ui":{"x":801,"y":209.51196172248802},"format":"table","distinct":true,"id":"962add59-ce72-4dea-b9d0-1408a19d2d10","table":"reporting.wpv_circumstances_class_lkup"}},{"name":"processing_risk_history","type":"table","nodeType":"source","description":"","properties":{"select":"file_id,\nrl_transaction_date,\ndms_batch_cycle,\nactivity_at_time_of_fall,\nactual_contributing_factor,\nadditional_location,\naddress1,\naddress2,\nage_at_event,\nbeing_reported,\ncalc_first_followup_signoff_submitted,\ncalc_submitted_date,\ncity,\nclosed_date,\ncontrolled_substance,\ndate_of_birth,\ndepartment,\ndept_divis_oplevel,\ndifferent_location,\ndose_administered,\ndrug_class_administered,\ndrug_name_generic_administered,\nentered_date,\nevent_age_integer,\nevent_preventable,\nexpert_review_process,\nfall_classification,\nfall_did_medication_contribute,\nfall_type,\nfda_reportable,\nfile_owner,\nfile_state,\nfile_status_name,\nfollowup_by,\nfollowup_date,\nfollowup_details,\nfollowup_sub_type,\nfollowup_time,\nfollowup_type,\ngender,\ngeneral_inc_type,\ngreat_catch_nomination,\nincident_date,\nincident_description,\nincident_time,\ninjury_inv,\ninput_time_span,\nissue_type,\nlast_risk_assessment,\nlevel_of_injury_from_fall,\nlot_number_administered,\nmedical_center,\nmed_fluid_stage_of_origin,\nmed_processes,\nmiddle_init,\nmobility_status_at_time_of_fall,\nmodified_date,\nmost_advanced_stage,\nmrn,\nnotified_date,\non_medication,\nopportunities_for_improvement,\norigin,\nother_code_response,\nother_code_response_notes,\nother_device_type,\nother_drug_class_administered,\nother_incident_type,\nother_wound_skin_condition,\noutcome_action_taken,\npatient_survive_event,\npc_zip,\nperson_affected_type,\nperson_aff_first_name,\nperson_aff_last_name,\nphysician_peer_review_referral,\nprimary_reasonhosp,\nprior_to_fall,\nprocess_issues_notes,\nprogram,\nrefer_to_peer_review,\nrm_category,\nrole_as_a_reporter,\nroute_administered,\nsafety_precautions,\nseverity_level,\nsitter_in_place,\nskin_tissue_device_type,\nskin_tissue_location,\nspecific_dietary_type,\nspecific_incident_type,\nstate,\nteam_code_blue,\nteam_rapid_response,\ntherapist_supervision,\ntime_call_initiated,\ntime_code_blue,\ntime_code_call_initiated,\ntime_rapid_response,\ntype_of_person_who_assisted_to_floor,\ntype_of_unit_after_intervention,\nulcer_location,\nulcer_type,\nunit_location_oplevel,\nwas_device_involved,\nwas_risk_assessment_done_on_admission,\nwas_this_fall_intentional,\nwas_witnessed,\nwere_restraints_in_place,\nwere_safety_precautions_in_place,\nwhen_where_division,\nwhen_where_location,\nwhen_where_unit,\nwound_skin_condition,\nwpv_anyothers_affected,\nwpv_classification_of_person,\nwpv_class_of_circumstances,\nwpv_date_reported_to_osha,\nwpv_employees_injured,\nwpv_event,\nwpv_law_enforcement_contacted,\nwpv_medical_treatment_provided,\nwpv_reportable_to_osha,\nwpv_security_contacted,\nwpv_time_off_work,\nwpv_type_of_incident,\nwpv_type_of_location,\nwpv_type_of_violence,\nfollowup_list_status,\ndate_rm_notified,\npin,\nrm_summary_single,\nhigh_risk_med_contribute,\nsubmit_file_to_tpa,\ncovid_19_event,\nivos_account_insured_code_udf,\n location","designSchema":35,"ui":{"x":9,"y":106},"format":"table","distinct":false,"id":"6c6e8498-3b5b-435a-9b3f-b430a9efb3db","table":"processing.risk_history"}},{"name":"filtered_risk_history","type":"filterprocessor","nodeType":"processor","description":"","properties":{"select":"file_id,\nrl_transaction_date,\ndms_batch_cycle,\nactivity_at_time_of_fall,\nactual_contributing_factor,\nadditional_location,\naddress1,\naddress2,\nage_at_event,\nbeing_reported,\ncalc_first_followup_signoff_submitted,\ncalc_submitted_date,\ncity,\nclosed_date,\ncontrolled_substance,\ndate_of_birth,\ndepartment,\ndept_divis_oplevel,\ndifferent_location,\ndose_administered,\ndrug_class_administered,\ndrug_name_generic_administered,\nentered_date,\nevent_age_integer,\nevent_preventable,\nexpert_review_process,\nfall_classification,\nfall_did_medication_contribute,\nfall_type,\nfda_reportable,\nfile_owner,\nfile_state,\nfile_status_name,\nfollowup_by,\nfollowup_date,\nfollowup_details,\nfollowup_sub_type,\nfollowup_time,\nfollowup_type,\ngender,\ngeneral_inc_type,\ngreat_catch_nomination,\nincident_date,\nincident_description,\nincident_time,\ninjury_inv,\ninput_time_span,\nissue_type,\nlast_risk_assessment,\nlevel_of_injury_from_fall,\nlot_number_administered,\nmedical_center,\nmed_fluid_stage_of_origin,\nmed_processes,\nmiddle_init,\nmobility_status_at_time_of_fall,\nmodified_date,\nmost_advanced_stage,\nmrn,\nnotified_date,\non_medication,\nopportunities_for_improvement,\norigin,\nother_code_response,\nother_code_response_notes,\nother_device_type,\nother_drug_class_administered,\nother_incident_type,\nother_wound_skin_condition,\noutcome_action_taken,\npatient_survive_event,\npc_zip,\nperson_affected_type,\nperson_aff_first_name,\nperson_aff_last_name,\nphysician_peer_review_referral,\nprimary_reasonhosp,\nprior_to_fall,\nprocess_issues_notes,\nprogram,\nrefer_to_peer_review,\nrm_category,\nrole_as_a_reporter,\nroute_administered,\nsafety_precautions,\nseverity_level,\nsitter_in_place,\nskin_tissue_device_type,\nskin_tissue_location,\nspecific_dietary_type,\nspecific_incident_type,\nstate,\nteam_code_blue,\nteam_rapid_response,\ntherapist_supervision,\ntime_call_initiated,\ntime_code_blue,\ntime_code_call_initiated,\ntime_rapid_response,\ntype_of_person_who_assisted_to_floor,\ntype_of_unit_after_intervention,\nulcer_location,\nulcer_type,\nunit_location_oplevel,\nwas_device_involved,\nwas_risk_assessment_done_on_admission,\nwas_this_fall_intentional,\nwas_witnessed,\nwere_restraints_in_place,\nwere_safety_precautions_in_place,\nwhen_where_division,\nwhen_where_location,\nwhen_where_unit,\nwound_skin_condition,\nwpv_anyothers_affected,\nwpv_classification_of_person,\nwpv_class_of_circumstances,\nwpv_date_reported_to_osha,\nwpv_employees_injured,\nwpv_event,\nwpv_law_enforcement_contacted,\nwpv_medical_treatment_provided,\nwpv_reportable_to_osha,\nwpv_security_contacted,\nwpv_time_off_work,\nwpv_type_of_incident,\nwpv_type_of_location,\nwpv_type_of_violence,\nfollowup_list_status,\ndate_rm_notified,\npin,\nrm_summary_single,\nhigh_risk_med_contribute,\nsubmit_file_to_tpa,\ncovid_19_event,\nivos_account_insured_code_udf,\nlocation","dependsOn":["processing_risk_history"],"ui":{"x":162,"y":126},"distinct":true,"where":"nvl(general_inc_type, '') NOT IN ('Access Request', 'User Access Change Request')","id":"575f8136-ef69-4d55-958c-442459dd4e06"}},{"name":"asof_risk","type":"sql","nodeType":"processor","description":"","properties":{"dependsOn":["filtered_risk_history"],"ui":{"x":297,"y":122},"id":"4ca239a1-a3f2-4a8b-bcf5-c9cef2550cd4","sql":"SELECT\n    rh.*\nFROM\n    filtered_risk_history rh,\n    (\n        SELECT\n            file_id,\n            location,\n            MAX(rl_transaction_date) AS rl_transaction_date\n        FROM\n            filtered_risk_history\n        GROUP BY\n            file_id,\n            location \n    ) maxrh\nWHERE\n    rh.location = maxrh.location\n    AND rh.file_id = maxrh.file_id\n    AND rh.rl_transaction_date = maxrh.rl_transaction_date"}},{"name":"processing_risk","type":"table","nodeType":"sink","description":"","properties":{"mode":"Overwrite","partitions":"5","dependsOn":["asof_risk"],"ui":{"x":427,"y":60},"batch":true,"distinct":false,"id":"75f89a2a-ecf2-4e95-9df3-b3f1193bca54","table":"processing.risk"}},{"name":"severity_lkup","type":"table","nodeType":"source","description":"","properties":{"select":"severity_level_grouping,\nseverity_level","designSchema":34,"ui":{"x":10,"y":234},"format":"table","distinct":true,"id":"06b49a48-6cce-444f-aa82-c24ddbc1be63","table":"reporting.risk_severity_level_grouping_lkup"}},{"name":"severity_lkup_pivot","type":"sql","nodeType":"processor","description":"","properties":{"dependsOn":["severity_lkup"],"ui":{"x":145,"y":234},"id":"234d4612-5741-4d57-aba3-e5e62180274d","sql":"SELECT\n    *\nFROM\n    (\n        SELECT\n            severity_level,\n            severity_level_grouping\n        FROM\n            severity_lkup\n    ) PIVOT (\n        COUNT(severity_level_grouping) FOR severity_level_grouping IN (\n            'All Severity Levels' AS slg_all_severity_levels_d,\n            'Event Reached Patient' AS slg_event_reached_patient_d,\n            'Event with Harm' AS slg_event_with_harm_d,\n            'Near Miss Event' AS slg_near_miss_event_d,\n            'Serious Safety Event' AS slg_serious_safety_event_d\n        )\n    )"}},{"name":"severity_lkup_r","type":"renamecolumnsprocessor","nodeType":"processor","description":"Rename severity level column name","properties":{"dependsOn":["severity_lkup_pivot"],"ui":{"x":279,"y":224},"renameColumns":[{"name":"severity_level_rename","description":"Rename column","properties":{"inputColumns":["severity_level"],"renameWith":["severity_level_l"]}}],"id":"10d15d79-66dd-4c6f-980a-67a480769860"}},{"name":"asof_risk_1","type":"join","nodeType":"processor","description":"As-of risk with severity level","properties":{"select":"asof_risk.*,\nseverity_lkup_r.*","joinOnKeys":"asof_risk.severity_level = severity_lkup_r.severity_level_l","dependsOn":["asof_risk","severity_lkup_r"],"ui":{"x":422,"y":229},"joinType":"LEFT OUTER JOIN","distinct":false,"id":"37fdbdf4-38a4-484a-b0e3-d611d9c97131"}},{"name":"asof_risk_2","type":"transformcolumnsprocessor","nodeType":"processor","description":"As-of risk with some transformations","properties":{"dependsOn":["asof_risk_1"],"ui":{"x":541,"y":136},"transforms":[{"name":"initcap_certain_cols","type":"customsql","properties":{"columns":["drug_name_generic_administered","drug_class_administered"],"transformType":"custom-expression","sql":"initcap(nvl($self,'Not Stated'))"}},{"name":"severity_level_grouping","type":"customsql","properties":{"columns":["slg_all_severity_levels_d","slg_event_with_harm_d","slg_event_reached_patient_d","slg_near_miss_event_d","slg_serious_safety_event_d"],"transformType":"case-when","sql":"case when $self is null then \"N\" else \"Y\" end","dependsOn":"asof_risk_2"}},{"name":"not_stated_for_nulls","type":"customsql","properties":{"columns":["file_state","med_fluid_stage_of_origin","role_as_a_reporter","severity_level","unit_location_oplevel","when_where_division","medical_center","file_status_name","person_affected_type","incident_description","dept_divis_oplevel","gender","wpv_event","wpv_type_of_incident","wpv_type_of_location","wpv_class_of_circumstances","wpv_classification_of_person","wpv_type_of_violence","wpv_employees_injured","wpv_medical_treatment_provided","wpv_time_off_work","wpv_security_contacted"],"transformType":"custom-expression","sql":"nvl($self,'Not Stated')","dependsOn":"asof_risk_2"}},{"name":"general_inc_type_safety_security","type":"customsql","properties":{"columns":["general_inc_type"],"transformType":"case-when","sql":"case when upper(general_inc_type) = 'SAFETY/SECURITY/WORKPLACE VIOLENCE' then 'Safety / Security' else general_inc_type end","dependsOn":"asof_risk_2"}}],"id":"47a26d7f-bb8f-4d3b-ab63-fcada62b2fa5"}},{"name":"asof_risk_3","type":"sql","nodeType":"processor","description":"As-of risk with first followup date","properties":{"dependsOn":["asof_risk_2"],"ui":{"x":667.4007092198582,"y":122},"id":"a9e17dbb-7427-4c7c-a07c-d7289023053c","sql":"SELECT\n    ar2.*,\n    nvl(mft.first_followup_date, CAST(\"9999-12-31 00:00:00\" AS timestamp)) first_followup_date\nFROM\n    asof_risk_2  ar2\n    LEFT OUTER JOIN (\n        SELECT\n            location,\n            file_id,\n            MIN(followup_date) AS first_followup_date\n        FROM\n            asof_risk_2\n        WHERE\n            followup_type IS NOT NULL\n        GROUP BY\n            location,\n            file_id\n    ) mft ON \n        ar2.location = mft.location\n        AND ar2.file_id = mft.file_id"}},{"name":"asof_risk_4","type":"sql","nodeType":"processor","description":"","properties":{"dependsOn":["asof_risk_3"],"ui":{"x":798,"y":123},"id":"7f637fe2-7a16-449e-b9d8-2771200e22e7","sql":"SELECT\n    ar3.*,\n    nvl(mft.first_followup_signoff_date, CAST(\"9999-12-31 00:00:00\" AS timestamp)) first_followup_signoff_date\nFROM\n    asof_risk_3  ar3\n    LEFT OUTER JOIN (\n        SELECT\n            location,\n            file_id,\n            MIN(followup_date) AS first_followup_signoff_date\n        FROM\n            asof_risk_3\n        WHERE\n            followup_type = 'Sign-Off'\n        GROUP BY\n            location,\n            file_id\n    ) mft ON \n        ar3.location = mft.location\n        AND ar3.file_id = mft.file_id"}},{"name":"asof_risk_5","type":"sql","nodeType":"processor","description":"As-of risk with first followup date","properties":{"dependsOn":["asof_risk_4","wpv_circumstances_class_lkup"],"ui":{"x":932,"y":127},"id":"318f3fb0-c7c4-4712-ad69-79cca74a30cf","sql":"SELECT\n    ar4.*,\n    nvl(ar4.wpv_class_of_circumstances, \"Other\") as wpv_class_of_circumstances_d\nFROM\n    asof_risk_4 ar4\n    LEFT OUTER JOIN wpv_circumstances_class_lkup wccl \n    ON ar4.wpv_class_of_circumstances = wccl.wpv_class_of_circumstances"}},{"name":"wpv_incident_type_lkup","type":"table","nodeType":"source","description":"","properties":{"select":"wpv_type_of_incident","designSchema":82,"ui":{"x":944,"y":209},"format":"table","distinct":true,"id":"6a4ccd11-5c91-4972-b69c-fda19cb27341","table":"reporting.wpv_incident_type_lkup"}},{"name":"asof_risk_6","type":"sql","nodeType":"processor","description":"As-of risk with first followup date","properties":{"dependsOn":["wpv_incident_type_lkup","asof_risk_5"],"ui":{"x":1070,"y":129},"id":"8f86daf7-9014-49ee-b826-f305ec07d15f","sql":"SELECT\n    ar5.*,\n    nvl(ar5.wpv_type_of_incident, \"Other\") as wpv_type_of_incident_d\nFROM\n    asof_risk_2 ar5\n    LEFT OUTER JOIN wpv_incident_type_lkup witl \n    ON ar5.wpv_type_of_incident = witl.wpv_type_of_incident"}},{"name":"asof_risk_add_cols","type":"addcolumnsprocessor","nodeType":"processor","description":"","properties":{"dependsOn":["asof_risk_6"],"addColumns":[{"name":"days_eventdate_submitteddate","properties":{"columns":["days_eventdate_submitteddate"],"sql":"datediff(calc_submitted_date,incident_date)"}},{"name":"days_submitteddate_caloshareporteddate","properties":{"columns":["days_submitteddate_caloshareporteddate"],"sql":"datediff(wpv_date_reported_to_osha,calc_submitted_date)"}},{"name":"file_id_location","properties":{"columns":["file_id_location"],"sql":"concat(location, file_id)"}},{"name":"time_to_submit_form_d","properties":{"columns":["time_to_submit_form_d"],"sql":"round(input_time_span/60, 2)"}},{"name":"submit_date_plus_15d_d","properties":{"columns":["submit_date_plus_15d_d"],"sql":"cast(date_add(calc_submitted_date, 15) as timestamp)"}},{"name":"date_calendar_year","description":"Calendar Year : Example 2013","properties":{"inputColumns":["incident_date","calc_submitted_date","closed_date","submit_file_to_tpa","wpv_date_reported_to_osha","notified_date"],"columns":["$self_year"],"transformType":"custom-expression","sql":"year($self)"}},{"name":"date_short_calendar_year_name","description":"Short Calendar Year Name : Example 2013","properties":{"inputColumns":["incident_date","calc_submitted_date","closed_date","submit_file_to_tpa","wpv_date_reported_to_osha","notified_date"],"columns":["$self_short_calendar_year"],"transformType":"custom-expression","sql":"cast(year($self) as string)"}},{"name":"date_calendar_year_quarter","description":"Calendar Year & Quarter : Example 20134","properties":{"inputColumns":["incident_date","calc_submitted_date","closed_date","submit_file_to_tpa","wpv_date_reported_to_osha","notified_date"],"columns":["$self_cal_qtr"],"transformType":"quarter(col)","sql":"(year($self) * 10) + quarter($self)"}},{"name":"date_calendar_year_quarter_name","description":"Short Calendar Year Name & Quarter : Example 2013 Q3","properties":{"inputColumns":["incident_date","calc_submitted_date","closed_date","submit_file_to_tpa","wpv_date_reported_to_osha","notified_date"],"columns":["$self_calendar_year_quarter_name"],"transformType":"custom-expression","sql":"concat(year($self), ' Q', quarter($self))"}},{"name":"date_calendar_year_month","description":"Calendar Year & Month : Example 201306","properties":{"inputColumns":["incident_date","calc_submitted_date","closed_date","submit_file_to_tpa","wpv_date_reported_to_osha","notified_date"],"columns":["$self_cal_year_month"],"transformType":"custom-expression","sql":"(year($self) * 100) + month($self)"}},{"name":"date_month_calendar_year","description":"Month & Calendar Year : Example Jun-2013","properties":{"inputColumns":["incident_date","calc_submitted_date","closed_date","submit_file_to_tpa","wpv_date_reported_to_osha","notified_date"],"columns":["$self_month_cal_year"],"transformType":"custom-expression","sql":"concat(date_format($self, 'MM'), \"-\", year($self))"}},{"name":"date_fiscal_year","description":"Fiscal Year : Example 2013","properties":{"inputColumns":["incident_date","calc_submitted_date","closed_date","submit_file_to_tpa","wpv_date_reported_to_osha","notified_date"],"columns":["$self_fiscal_year"],"transformType":"custom-expression","sql":"case when (quarter($self) > 2) then year($self) + 1 else year($self) end "}},{"name":"date_fiscal_year_quarter","description":"Fiscal Year & Quarter : Example 201304","properties":{"inputColumns":["incident_date","calc_submitted_date","closed_date","submit_file_to_tpa","wpv_date_reported_to_osha","notified_date"],"columns":["$self_cal_qtr"],"transformType":"quarter(col)","sql":"case when (quarter($self) > 2) then\n((year($self) + 1) * 10) + quarter($self) - 2\nelse \n(year($self) * 10) + quarter($self) + 2\nend"}},{"name":"date_short_fiscal_year_quarter","description":"Short Fiscal Year Name & Quarter : Example FY13 Q3","properties":{"inputColumns":["incident_date","calc_submitted_date","closed_date","submit_file_to_tpa","wpv_date_reported_to_osha","notified_date"],"columns":["$self_fiscal_year_quarter"],"transformType":"custom-expression","sql":"case when (quarter($self) > 2) then \nconcat('FY', substring(cast((year($self) + 1) as string), 3, 2), ' Q', (quarter($self) - 2))\nelse \nconcat('FY', substring(cast(year($self) as string), 3, 2), ' Q', (quarter($self) + 2)) end"}},{"name":"date_short_fiscal_year_name","description":"Short Fiscal Year Name : Example FY13","properties":{"inputColumns":["incident_date","calc_submitted_date","closed_date","submit_file_to_tpa","wpv_date_reported_to_osha","notified_date"],"columns":["$self_fy_year"],"transformType":"custom-expression","sql":"case when (quarter($self) > 2) then concat('FY', substring(cast((year($self) + 1) as string), 3, 2)) else concat('FY', substring(cast(year($self) as string), 3, 2)) end"}}],"ui":{"x":1206,"y":132},"id":"dc2710d3-04d8-4807-93d8-d2b42e913a8e"}},{"name":"asof_risk_drop_cols","type":"dropcolumnsprocessor","nodeType":"processor","description":"","properties":{"dropColumns":"severity_level_l","dependsOn":["asof_risk_add_cols"],"ui":{"x":1336,"y":134},"id":"5d7ae94d-a169-4a1f-ba5b-c5046b121a17"}},{"name":"reporting_risk_folder","type":"fileparquet","nodeType":"sink","description":"","properties":{"mode":"Overwrite","partitions":"5","path":"s3://rdms-kwartile/risk_reporting/file","partitionBy":"location","dependsOn":["asof_risk_drop_cols"],"ui":{"x":1466,"y":131},"batch":true,"format":"parquet","id":"a3e3ad0f-2a18-4641-93e1-1861a01dd9d1"}}]}